<!DOCTYPE html>
<html>
<body style="margin:0; background:black; overflow:hidden;">
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: black;
        }
        #player {
            width: 100%;
            height: 100%;
        }
    </style>
    
    <div id="player"></div>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        const socket = io('https://ams-il.onrender.com/', {transports: ['websocket', 'polling']});
        
        // Chargement API YouTube
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        var player;
        let isSyncing = false;

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '100%', width: '100%',
                videoId: 'RzVvThhjAKw',
                playerVars: { 'autoplay': 1, 'mute': 1, 'controls': 1 },
                events: { 
                    'onStateChange': onPlayerStateChange,
                    'onPlaybackRateChange' : (e) => { if(!isSyncing) socket.emit('changeSpeed', e.data); }
                }
            });
        }

        function onPlayerStateChange(event) {
            if (isSyncing) return;
            if (event.data == YT.PlayerState.PLAYING) {
                socket.emit('play');
                socket.emit('syncAction', { videoTime: player.getCurrentTime(), clockTime: Date.now() });
            } else if (event.data == YT.PlayerState.PAUSED) {
                socket.emit('pause');
            }
        }

        // Ã‰couteurs Socket (Play, Pause, Sync, ChangeVideo)
        socket.on('play', () => { isSyncing = true; player.playVideo(); setTimeout(() => isSyncing = false, 500); });
        socket.on('pause', () => { isSyncing = true; player.pauseVideo(); setTimeout(() => isSyncing = false, 500); });
        
        socket.on('syncAction', (data) => {
            const drift = Math.abs(player.getCurrentTime() - data.videoTime);
            if (drift > 1.5) {
                isSyncing = true;
                player.seekTo(data.videoTime, true);
                setTimeout(() => isSyncing = false, 800);
            }
        });

        socket.on('changeVideo', (videoId) => {
            isSyncing = true;
            player.loadVideoById(videoId);
            setTimeout(() => isSyncing = false, 1000);
        });
    </script>
</body>
</html>